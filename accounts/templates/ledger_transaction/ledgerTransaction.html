{% extends 'header.html' %} {% load static %} {% block body %}

<div class="container-fluid mt-3 px-2 px-md-4">
  <!-- Header Section -->
  <div class="row align-items-center mb-3">
    <div class="col-6">
      <h5 class="mb-0" style="color: var(--primary);">
        <i class="fas fa-address-book me-1 d-none d-md-inline"></i>
        {{ counter_party }}
      </h5>
    </div>
    
    <div class="col-6 text-end">
      <div class="btn-group btn-group-sm" role="group">
        <a href="/ledger-transaction-details/" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-arrow-left"></i>
          <span class="d-none d-md-inline ms-1">Back</span>
        </a>
        <a href="/deleted-ledger-transaction/" class="btn btn-outline-danger btn-sm d-none d-md-inline-block">
          <i class="fa-solid fa-trash me-1"></i>Deleted
        </a>
      </div>
    </div>
  </div>

  <!-- Desktop: Table View -->
  <div class="d-none d-lg-block">
    {% if transaction_data %}
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <form method="POST" action="/update-ledger-transaction-status/">
            {% csrf_token %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="ps-3" width="40"><input type="checkbox" class="form-check-input" id="select-all-checkbox"></th>
                    <th>Type</th>
                    <th>Counterparty</th>
                    <th>Amount (₹)</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Due Date</th>
                    <th>Description</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for txn in transaction_data %}
                    <tr>
                      <td class="ps-3">
                        <input type="checkbox" class="form-check-input" name="record_ids" value="{{ txn.id }}">
                      </td>
                      <td>
                        {% if txn.transaction_type == 'RECEIVABLE' or txn.transaction_type == 'RECEIVED' %}
                          <span class="badge badge-receivable">
                            <i class="fas fa-arrow-down me-1"></i>{{ txn.get_transaction_type_display }}
                          </span>
                        {% else %}
                          <span class="badge badge-payable">
                            <i class="fas fa-arrow-up me-1"></i>{{ txn.get_transaction_type_display }}
                          </span>
                        {% endif %}
                        {% if txn.installment_number %}
                          <span class="badge badge-installment ms-1">{{ txn.installment_number }}/{{ txn.total_installments }}</span>
                        {% endif %}
                      </td>
                      <td>
                        <strong>{{ txn.counterparty }}</strong>
                        {% if txn.tags %}
                          <br><small>
                            {% for tag in txn.tags|slice:":3" %}
                              <span class="badge bg-light text-dark">{{ tag }}</span>
                            {% endfor %}
                          </small>
                        {% endif %}
                      </td>
                      <td>
                        <strong class="{% if txn.transaction_type == 'RECEIVABLE' or txn.transaction_type == 'RECEIVED' %}text-receivable{% else %}text-payable{% endif %}">
                          ₹{{ txn.amount }}
                        </strong>
                        {% if txn.status == 'PARTIAL' %}
                          <br><small class="text-muted">Paid: ₹{{ txn.paid_amount }}</small>
                        {% endif %}
                      </td>
                      <td>
                        {% if txn.status == 'COMPLETED' %}
                          <span class="badge badge-status-completed"><i class="fas fa-check-circle me-1"></i>Completed</span>
                        {% elif txn.status == 'PARTIAL' %}
                          <span class="badge badge-status-partial"><i class="fas fa-circle-half-stroke me-1"></i>{{ txn.get_payment_percentage }}%</span>
                          <div class="progress mt-1" style="height: 4px; width: 60px;">
                            <div class="progress-bar" style="width: {{ txn.get_payment_percentage }}%"></div>
                          </div>
                        {% elif txn.status == 'CANCELLED' %}
                          <span class="badge badge-status-cancelled"><i class="fas fa-ban me-1"></i>Cancelled</span>
                        {% else %}
                          <span class="badge badge-status-pending"><i class="fas fa-clock me-1"></i>Pending</span>
                        {% endif %}
                        {% if txn.is_overdue %}
                          <br><span class="badge badge-overdue mt-1"><i class="fas fa-exclamation-triangle"></i> {{ txn.days_overdue }}d</span>
                        {% endif %}
                      </td>
                      <td>{{ txn.transaction_date|date:"d M Y" }}</td>
                      <td>
                        {% if txn.due_date %}
                          {{ txn.due_date|date:"d M Y" }}
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td>
                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ txn.description }}">
                          {{ txn.description|default:"-" }}
                        </span>
                      </td>
                      <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                          <button type="button" class="btn btn-outline-primary" onclick="editTransaction({{ txn.id }})" title="Edit">
                            <i class="fas fa-edit"></i>
                          </button>
                          {% if txn.status == 'PENDING' or txn.status == 'PARTIAL' %}
                            <button type="button" class="btn btn-success" 
                                    onclick="openPaymentModal({{ txn.id }}, '{{ txn.description|escapejs }}', '{{ txn.counterparty }}', {{ txn.amount }}, {{ txn.paid_amount }}, {{ txn.remaining_amount }})" 
                                    title="Record Payment">
                              <i class="fas fa-money-bill-wave"></i>
                            </button>
                          {% endif %}
                          <button type="button" class="btn btn-outline-danger" 
                                  data-bs-toggle="modal" data-bs-target="#confirmModal" 
                                  data-url="/delete-ledger-transaction/{{ txn.id }}" 
                                  title="Delete">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </form>
        </div>
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-file-invoice fa-3x text-muted mb-3 opacity-50"></i>
        <h6 class="text-muted">No transactions found</h6>
      </div>
    {% endif %}
  </div>

  <!-- Mobile & Tablet: Card View -->
  <div class="d-lg-none">
    {% if transaction_data %}
      <form method="POST" action="/update-ledger-transaction-status/">
        {% csrf_token %}
        
        {% for txn in transaction_data %}
          <div class="card border-0 shadow-sm mb-2 transaction-card">
            <div class="card-body p-2 p-md-3">
              <div class="row g-2 align-items-center">
                <!-- Top Row - Type & Actions -->
                <div class="col-12">
                  <div class="d-flex justify-content-between align-items-start">
                    <!-- Type Badge -->
                    <div>
                      {% if txn.transaction_type == 'RECEIVABLE' or txn.transaction_type == 'RECEIVED' %}
                        <span class="badge badge-receivable">
                          <i class="fas fa-arrow-down"></i> {{ txn.get_transaction_type_display }}
                        </span>
                      {% else %}
                        <span class="badge badge-payable">
                          <i class="fas fa-arrow-up"></i> {{ txn.get_transaction_type_display }}
                        </span>
                      {% endif %}
                      
                      {% if txn.installment_number %}
                        <span class="badge badge-installment ms-1">{{ txn.installment_number }}/{{ txn.total_installments }}</span>
                      {% endif %}
                    </div>

                    <!-- Actions Dropdown -->
                    <div class="dropdown">
                      <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                          <a class="dropdown-item" href="#" onclick="editTransaction({{ txn.id }}); return false;">
                            <i class="fas fa-edit me-2"></i>Edit
                          </a>
                        </li>
                        {% if txn.status == 'PENDING' or txn.status == 'PARTIAL' %}
                        <li>
                          <a class="dropdown-item" href="#" 
                             onclick="openPaymentModal({{ txn.id }}, '{{ txn.description|escapejs }}', '{{ txn.counterparty }}', {{ txn.amount }}, {{ txn.paid_amount }}, {{ txn.remaining_amount }}); return false;">
                            <i class="fas fa-money-bill-wave me-2"></i>Record Payment
                          </a>
                        </li>
                        {% endif %}
                        {% if txn.attachment %}
                        <li>
                          <a class="dropdown-item" href="{{ txn.attachment.url }}" download>
                            <i class="fas fa-download me-2"></i>Download File
                          </a>
                        </li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item text-danger" href="#" 
                             data-bs-toggle="modal" data-bs-target="#confirmModal" 
                             data-url="/delete-ledger-transaction/{{ txn.id }}">
                            <i class="fas fa-trash me-2"></i>Delete
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- Main Content -->
                <div class="col-12">
                  <!-- Amount -->
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="mb-0 {% if txn.transaction_type == 'RECEIVABLE' or txn.transaction_type == 'RECEIVED' %}text-receivable{% else %}text-payable{% endif %}">
                      ₹{{ txn.amount }}
                    </h6>
                  </div>

                  <!-- Description -->
                  <p class="mb-1 small text-muted text-truncate">{{ txn.description|default:"No description" }}</p>

                  <!-- Status & Date Row -->
                  <div class="d-flex flex-wrap gap-2 align-items-center small">
                    <!-- Status -->
                    {% if txn.status == 'COMPLETED' %}
                      <span class="badge badge-status-completed">✓ Paid</span>
                    {% elif txn.status == 'PARTIAL' %}
                      <span class="badge badge-status-partial">{{ txn.get_payment_percentage }}% Paid</span>
                    {% elif txn.status == 'CANCELLED' %}
                      <span class="badge badge-status-cancelled">Cancelled</span>
                    {% else %}
                      <span class="badge badge-status-pending">Pending</span>
                    {% endif %}

                    <!-- Overdue -->
                    {% if txn.is_overdue %}
                      <span class="badge badge-overdue">
                        <i class="fas fa-exclamation-triangle"></i> {{ txn.days_overdue }}d overdue
                      </span>
                    {% endif %}

                    <!-- Date -->
                    <span class="text-muted">
                      <i class="far fa-calendar me-1"></i>{{ txn.transaction_date|date:"d M" }}
                    </span>

                    <!-- Tags -->
                    {% if txn.tags %}
                      {% for tag in txn.tags|slice:":2" %}
                        <span class="badge bg-light text-dark">{{ tag }}</span>
                      {% endfor %}
                    {% endif %}
                  </div>

                  <!-- Progress Bar (if partial) -->
                  {% if txn.status == 'PARTIAL' %}
                    <div class="mt-2">
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar" style="width: {{ txn.get_payment_percentage }}%"></div>
                      </div>
                      <small class="text-muted">₹{{ txn.remaining_amount }} remaining</small>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </form>
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-file-invoice fa-3x text-muted mb-3 opacity-50"></i>
        <h6 class="text-muted">No transactions found</h6>
      </div>
    {% endif %}
  </div>
</div>

<!-- Include Modals -->
{% include 'ledger_transaction/ledgerTransactionModal.html' %}
{% include 'ledger_transaction/payment_modal.html' %}
{% include 'utility/confirmation_modal.html' with title='Confirm Delete' body='Are you sure you want to delete this transaction?' confirmButton='Delete' %}

<style>
:root {
  --ledger-receivable: #28a745;
  --ledger-receivable-light: rgba(40, 167, 69, 0.1);
  --ledger-payable: #ffc107;
  --ledger-payable-light: rgba(255, 193, 7, 0.1);
  --ledger-info: #17a2b8;
  --ledger-info-light: rgba(23, 162, 184, 0.1);
  --ledger-danger: #dc3545;
  --ledger-danger-light: rgba(220, 53, 69, 0.1);
}

.bg-success-soft {
  background-color: var(--ledger-receivable-light);
}

.bg-warning-soft {
  background-color: var(--ledger-payable-light);
}

.badge-receivable {
  background-color: var(--ledger-receivable-light);
  color: var(--ledger-receivable);
  border: 1px solid var(--ledger-receivable);
}

.badge-payable {
  background-color: var(--ledger-payable-light);
  color: #856404;
  border: 1px solid var(--ledger-payable);
}

.badge-status-completed {
  background-color: var(--ledger-receivable-light);
  color: var(--ledger-receivable);
  border: 1px solid var(--ledger-receivable);
}

.badge-status-partial {
  background-color: var(--ledger-info-light);
  color: var(--ledger-info);
  border: 1px solid var(--ledger-info);
}

.badge-status-pending {
  background-color: var(--ledger-payable-light);
  color: #856404;
  border: 1px solid var(--ledger-payable);
}

.badge-status-cancelled {
  background-color: rgba(108, 117, 125, 0.1);
  color: #6c757d;
  border: 1px solid #6c757d;
}

.badge-overdue {
  background-color: var(--ledger-danger-light);
  color: var(--ledger-danger);
  border: 1px solid var(--ledger-danger);
}

.badge-installment {
  background-color: var(--ledger-info-light);
  color: var(--ledger-info);
  border: 1px solid var(--ledger-info);
}

.text-receivable {
  color: var(--ledger-receivable);
}

.text-payable {
  color: #856404;
}

.transaction-card {
  transition: box-shadow 0.2s;
}

.transaction-card:hover {
  box-shadow: 0 .25rem .75rem rgba(0,0,0,.1)!important;
}

.badge {
  font-size: 0.7rem;
  font-weight: 500;
  padding: 0.35em 0.65em;
}

.table {
  font-size: 0.9rem;
}

.table th {
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--primary-dark);
  border-bottom: 2px solid #dee2e6;
  background-color: rgba(176, 163, 111, 0.08);
}

.table tbody tr:hover {
  background-color: rgba(176, 163, 111, 0.05);
}

.progress-bar {
  background-color: var(--primary);
}

.btn-group .btn {
  border-color: var(--primary);
}

.btn-outline-primary {
  color: var(--primary);
  border-color: var(--primary);
}

.btn-outline-primary:hover {
  background-color: var(--primary);
  color: white;
}

.btn-outline-danger {
  color: var(--ledger-danger);
  border-color: var(--ledger-danger);
}

.btn-outline-danger:hover {
  background-color: var(--ledger-danger);
  color: white;
}

/* Mobile specific */
@media (max-width: 992px) {
  .card-body {
    font-size: 0.9rem;
  }
  
  h6 {
    font-size: 1.1rem;
  }
  
  .small {
    font-size: 0.8rem;
  }
  
  .badge {
    font-size: 0.65rem;
    padding: 0.25em 0.5em;
  }
}
</style>

{% endblock body %}

{% block script %}
<script src="{% static 'js/ledger.js' %}"></script>
<script src="{% static 'js/utilityFunction.js' %}"></script>
{% endblock script %}
