<!-- Enhanced Ledger Transaction Modal with All New Features -->
{% load static %}
<div class="modal fade" id="ledgerModal" tabindex="-1" aria-labelledby="ledgerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ledgerModalLabel">
          <i class="fas fa-receipt me-2"></i> Add Ledger Transaction
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form action="/create-ledger-transaction/" id="myLedgerForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="transaction_id" name="transaction_id">

          <!-- Transaction Type -->
          <div class="mb-4">
            <label class="form-label fw-bold">Transaction Type</label>
            <div class="row g-2">
              <div class="col-6 col-md-3">
                <input class="btn-check" type="radio" name="transaction_type" id="receivable" value="RECEIVABLE" required>
                <label class="btn btn-outline-success w-100" for="receivable">
                  <i class="fas fa-arrow-down"></i> To Receive
                </label>
              </div>
              <div class="col-6 col-md-3">
                <input class="btn-check" type="radio" name="transaction_type" id="payable" value="PAYABLE">
                <label class="btn btn-outline-warning w-100" for="payable">
                  <i class="fas fa-arrow-up"></i> To Pay
                </label>
              </div>
              <div class="col-6 col-md-3">
                <input class="btn-check" type="radio" name="transaction_type" id="received" value="RECEIVED">
                <label class="btn btn-outline-primary w-100" for="received">
                  <i class="fas fa-check-circle"></i> Received
                </label>
              </div>
              <div class="col-6 col-md-3">
                <input class="btn-check" type="radio" name="transaction_type" id="paid" value="PAID">
                <label class="btn btn-outline-danger w-100" for="paid">
                  <i class="fas fa-check-circle"></i> Paid
                </label>
              </div>
            </div>
          </div>

          <!-- Counterparty Information -->
          <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body">
              <h6 class="card-title mb-3"><i class="fas fa-user-tie me-2"></i> Counterparty Details</h6>
              
              <div class="mb-3">
                <label for="counterparty" class="form-label">Counterparty <span class="text-danger">*</span></label>
                <select class="form-select" name="counterparty" id="counterparty" onchange="counterpartyChange()" required>
                  <option value="">- Select Counterparty -</option>
                  {% for counterparty in counterparties %}
                  <option value="{{ counterparty }}">{{ counterparty }}</option>
                  {% endfor %}
                  <option value="other">+ Add New</option>
                </select>
              </div>

              <div class="mb-3" id="counterparty_txt_div" style="display:none;">
                <input type="text" class="form-control" name="counterparty" id="counterparty_txt" placeholder="Enter New Counterparty Name">
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="counterparty_contact" class="form-label">Contact Number</label>
                  <input type="tel" class="form-control" name="counterparty_contact" id="counterparty_contact" placeholder="+91 98765 43210">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="counterparty_email" class="form-label">Email</label>
                  <input type="email" class="form-control" name="counterparty_email" id="counterparty_email" placeholder="email@example.com">
                </div>
              </div>
            </div>
          </div>

          <!-- Transaction Details -->
          <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body">
              <h6 class="card-title mb-3"><i class="fas fa-file-invoice me-2"></i> Transaction Information</h6>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="transaction_date" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" name="transaction_date" id="transaction_date" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="due_date" class="form-label">Due Date</label>
                  <input type="date" class="form-control" name="due_date" id="due_date">
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="amount" class="form-label">Amount (₹) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" name="amount" id="amount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="col-md-6 mb-3" id="payment_method_div" style="display:none;">
                  <label for="payment_method" class="form-label">Payment Method</label>
                  <select class="form-select" name="payment_method" id="payment_method">
                    <option value="">- Select Method -</option>
                    <option value="CASH">Cash</option>
                    <option value="BANK_TRANSFER">Bank Transfer</option>
                    <option value="UPI">UPI</option>
                    <option value="CHEQUE">Cheque</option>
                    <option value="CARD">Card</option>
                    <option value="OTHER">Other</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="reference_number" class="form-label">Reference Number</label>
                  <input type="text" class="form-control" name="reference_number" id="reference_number" placeholder="REF-001">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="invoice_number" class="form-label">Invoice Number</label>
                  <input type="text" class="form-control" name="invoice_number" id="invoice_number" placeholder="INV-001">
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" name="description" id="description" rows="2" placeholder="Transaction details..."></textarea>
              </div>

              <div class="mb-3">
                <label for="notes" class="form-label">Additional Notes</label>
                <textarea class="form-control" name="notes" id="notes" rows="2" placeholder="Any additional information..."></textarea>
              </div>
            </div>
          </div>

          <!-- Installments Section -->
          <div class="card mb-3 border-0 shadow-sm" id="installment_card">
            <div class="card-body">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="enable_installments" name="enable_installments" onchange="toggleInstallments()">
                <label class="form-check-label fw-bold" for="enable_installments">
                  <i class="fas fa-calendar-alt me-2"></i> Split into Installments
                </label>
              </div>

              <div id="installment_settings" style="display:none;">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="no_of_installments" class="form-label">Number of Installments</label>
                    <input type="number" class="form-control" name="no_of_installments" id="no_of_installments" value="1" min="1" max="100" onchange="previewInstallments()">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="installment_frequency" class="form-label">Frequency</label>
                    <select class="form-select" name="installment_frequency" id="installment_frequency" onchange="toggleCustomDays()">
                      <option value="MONTHLY">Monthly</option>
                      <option value="WEEKLY">Weekly</option>
                      <option value="CUSTOM">Custom</option>
                    </select>
                  </div>
                </div>

                <div class="mb-3" id="custom_days_div" style="display:none;">
                  <label for="custom_days" class="form-label">Custom Interval (Days)</label>
                  <input type="number" class="form-control" name="custom_days" id="custom_days" placeholder="e.g., 15 for bi-weekly" min="1">
                </div>

                <div id="installment_preview" class="alert alert-info" style="display:none;">
                  <strong>Preview:</strong>
                  <div id="preview_content"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tags and Attachment -->
          <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body">
              <h6 class="card-title mb-3"><i class="fas fa-tags me-2"></i> Organization</h6>
              
              <div class="mb-3">
                <label for="tags" class="form-label">Tags</label>
                <input type="text" class="form-control" name="tags" id="tags" placeholder="supplies, materials, urgent (comma-separated)">
                <small class="text-muted">Separate tags with commas</small>
              </div>

              <div class="mb-3">
                <label for="attachment" class="form-label">Attachment</label>
                <input type="file" class="form-control" name="attachment" id="attachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                <small class="text-muted">Invoice, receipt, or supporting document</small>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="d-grid">
            <button type="submit" class="btn custom-btn-primary btn-lg" id="submitButton">
              <i class="fas fa-save me-2"></i> Save Transaction
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
  // Initialize date to today
  const dateInput = document.getElementById('transaction_date');
  if (dateInput) {
    dateInput.value = new Date().toISOString().split('T')[0];
  }
  
  // Show payment method for completed transactions
  document.querySelectorAll('input[name="transaction_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const paymentDiv = document.getElementById('payment_method_div');
      if (paymentDiv) {
        if (this.value === 'RECEIVED' || this.value === 'PAID') {
          paymentDiv.style.display = 'block';
        } else {
          paymentDiv.style.display = 'none';
        }
      }
    });
  });
});

// Show/hide counterparty text input
function counterpartyChange() {
  const select = document.getElementById('counterparty');
  const textDiv = document.getElementById('counterparty_txt_div');
  
  if (!select || !textDiv) {
    console.error('Counterparty elements not found');
    return;
  }
  
  console.log('Counterparty changed to:', select.value);
  
  if (select.value === 'other') {
    textDiv.style.display = 'block';
    // Disable the select and focus on text input
    const textInput = document.getElementById('counterparty_txt');
    if (textInput) {
      textInput.focus();
      // Remove required from select when using text input
      select.removeAttribute('required');
      textInput.setAttribute('required', 'required');
    }
  } else {
    textDiv.style.display = 'none';
    // Re-enable select
    const textInput = document.getElementById('counterparty_txt');
    if (textInput) {
      textInput.removeAttribute('required');
      select.setAttribute('required', 'required');
    }
  }
}

// Toggle installment settings
function toggleInstallments() {
  const checkbox = document.getElementById('enable_installments');
  const settings = document.getElementById('installment_settings');
  if (!checkbox || !settings) return;
  
  settings.style.display = checkbox.checked ? 'block' : 'none';
  if (checkbox.checked) {
    previewInstallments();
  }
}

// Toggle custom days field
function toggleCustomDays() {
  const frequency = document.getElementById('installment_frequency');
  const customDiv = document.getElementById('custom_days_div');
  if (!frequency || !customDiv) return;
  
  customDiv.style.display = frequency.value === 'CUSTOM' ? 'block' : 'none';
  previewInstallments();
}

// Preview installments
function previewInstallments() {
  const amountInput = document.getElementById('amount');
  const numInput = document.getElementById('no_of_installments');
  const frequencyInput = document.getElementById('installment_frequency');
  
  if (!amountInput || !numInput || !frequencyInput) return;
  
  const amount = parseFloat(amountInput.value) || 0;
  const numInstallments = parseInt(numInput.value) || 1;
  const frequency = frequencyInput.value;
  
  if (amount > 0 && numInstallments > 1) {
    const installmentAmount = (amount / numInstallments).toFixed(2);
    const preview = document.getElementById('installment_preview');
    const content = document.getElementById('preview_content');
    
    if (preview && content) {
      let frequencyText = frequency === 'MONTHLY' ? 'month' : frequency === 'WEEKLY' ? 'week' : 'custom period';
      
      content.innerHTML = `
        <div class="mt-2">
          <p class="mb-1"><strong>${numInstallments}</strong> installments of <strong>₹${installmentAmount}</strong> each</p>
          <p class="mb-0 text-muted"><small>Frequency: ${frequency.toLowerCase()}</small></p>
        </div>
      `;
      preview.style.display = 'block';
    }
  } else {
    const preview = document.getElementById('installment_preview');
    if (preview) {
      preview.style.display = 'none';
    }
  }
}

// Global function to populate form for editing (called from parent page)
window.editTransaction = function(txnId) {
  fetch(`/update-ledger-transaction/${txnId}`)
    .then(response => response.json())
    .then(data => {
      // Set hidden ID
      document.getElementById('transaction_id').value = data.id;
      
      // Set transaction type
      document.querySelectorAll('input[name="transaction_type"]').forEach(radio => {
        radio.checked = (radio.value === data.transaction_type);
      });
      
      // Set counterparty (case-insensitive search)
      const counterpartySelect = document.getElementById('counterparty');
      const options = Array.from(counterpartySelect.options);
      // Try exact match first
      let foundOption = options.find(opt => opt.value === data.counterparty);
      // Try case-insensitive match
      if (!foundOption && data.counterparty) {
        foundOption = options.find(opt => opt.value.toUpperCase() === data.counterparty.toUpperCase());
      }
      
      if (foundOption) {
        counterpartySelect.value = foundOption.value;
        console.log('Counterparty set to:', foundOption.value);
      } else if (data.counterparty) {
        // Not in dropdown, set as "other" and show text input
        counterpartySelect.value = 'other';
        document.getElementById('counterparty_txt').value = data.counterparty;
        document.getElementById('counterparty_txt_div').style.display = 'block';
        console.log('Counterparty set as other:', data.counterparty);
      }
      
      // Set counterparty details
      document.getElementById('counterparty_contact').value = data.counterparty_contact || '';
      document.getElementById('counterparty_email').value = data.counterparty_email || '';
      
      // Set dates and amounts
      document.getElementById('transaction_date').value = data.transaction_date;
      document.getElementById('due_date').value = data.due_date || '';
      document.getElementById('amount').value = data.amount;
      
      // Set other fields
      document.getElementById('description').value = data.description || '';
      document.getElementById('reference_number').value = data.reference_number || '';
      document.getElementById('invoice_number').value = data.invoice_number || '';
      document.getElementById('notes').value = data.notes || '';
      document.getElementById('tags').value = data.tags || '';
      
      // Set payment method if applicable
      if (data.payment_method) {
        document.getElementById('payment_method').value = data.payment_method;
        document.getElementById('payment_method_div').style.display = 'block';
      }
      
      // Hide installment section when editing
      document.getElementById('installment_card').style.display = 'none';
      
      // Update modal title and button
      document.getElementById('ledgerModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Transaction';
      document.getElementById('submitButton').innerHTML = '<i class="fas fa-save me-2"></i>Update Transaction';
      
      // Change form action to update
      document.getElementById('myLedgerForm').action = `/update-ledger-transaction/${txnId}`;
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('ledgerModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading transaction details');
    });
};

// Reset modal when closing
document.getElementById('ledgerModal').addEventListener('hidden.bs.modal', function() {
  // Reset form
  document.getElementById('myLedgerForm').reset();
  document.getElementById('transaction_id').value = '';
  
  // Reset action and labels
  document.getElementById('myLedgerForm').action = '/create-ledger-transaction/';
  document.getElementById('ledgerModalLabel').innerHTML = '<i class="fas fa-receipt me-2"></i>Add Ledger Transaction';
  document.getElementById('submitButton').innerHTML = '<i class="fas fa-save me-2"></i>Save Transaction';
  
  // Show installment section
  document.getElementById('installment_card').style.display = 'block';
  
  // Reset date to today
  document.getElementById('transaction_date').value = new Date().toISOString().split('T')[0];
  
  // Hide optional divs
  document.getElementById('counterparty_txt_div').style.display = 'none';
  document.getElementById('payment_method_div').style.display = 'none';
  document.getElementById('installment_settings').style.display = 'none';
});
</script>

<style>
.btn-check:checked + .btn-outline-success {
  background-color: #28a745;
  color: white;
}
.btn-check:checked + .btn-outline-warning {
  background-color: #ffc107;
  color: #000;
}
.btn-check:checked + .btn-outline-primary {
  background-color: #007bff;
  color: white;
}
.btn-check:checked + .btn-outline-danger {
  background-color: #dc3545;
  color: white;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .modal-dialog {
    margin: 0.5rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  .btn {
    font-size: 0.875rem;
  }
}
</style>
