<!-- Payment Recording Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="paymentModalLabel">
          <i class="fas fa-money-bill-wave me-2"></i> Record Payment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Transaction Summary -->
        <div class="card mb-3 bg-light border-0">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p class="mb-1"><strong>Transaction:</strong> <span id="payment_description">-</span></p>
                <p class="mb-1"><strong>Counterparty:</strong> <span id="payment_counterparty">-</span></p>
              </div>
              <div class="col-md-6">
                <p class="mb-1"><strong>Total Amount:</strong> ₹<span id="payment_total">0.00</span></p>
                <p class="mb-1"><strong>Paid:</strong> ₹<span id="payment_paid">0.00</span></p>
                <p class="mb-0"><strong class="text-danger">Remaining:</strong> ₹<span id="payment_remaining" class="text-danger fw-bold">0.00</span></p>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="mt-3">
              <label class="small text-muted">Payment Progress</label>
              <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     id="payment_progress_bar" 
                     style="width: 0%"
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                  <span id="payment_progress_text">0%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Form -->
        <form id="recordPaymentForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="transaction_id" name="transaction_id">

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="payment_date" class="form-label">Payment Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="payment_date" id="payment_date" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="amount_paid" class="form-label">Amount Paid (₹) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" name="amount_paid" id="amount_paid" 
                     placeholder="0.00" step="0.01" required onchange="validatePaymentAmount()">
              <small class="text-danger" id="amount_error" style="display:none;">Amount exceeds remaining balance!</small>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="payment_method_record" class="form-label">Payment Method <span class="text-danger">*</span></label>
              <select class="form-select" name="payment_method" id="payment_method_record" required>
                <option value="">- Select Method -</option>
                <option value="CASH">Cash</option>
                <option value="BANK_TRANSFER">Bank Transfer</option>
                <option value="UPI">UPI</option>
                <option value="CHEQUE">Cheque</option>
                <option value="CARD">Card</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="reference_number_payment" class="form-label">Reference Number</label>
              <input type="text" class="form-control" name="reference_number" id="reference_number_payment" placeholder="TXN12345">
            </div>
          </div>

          <div class="mb-3">
            <label for="payment_notes" class="form-label">Notes</label>
            <textarea class="form-control" name="notes" id="payment_notes" rows="2" placeholder="Additional payment details..."></textarea>
          </div>

          <div class="mb-3">
            <label for="receipt_file" class="form-label">Receipt/Proof</label>
            <input type="file" class="form-control" name="receipt_file" id="receipt_file" accept=".pdf,.jpg,.jpeg,.png">
            <small class="text-muted">Upload payment receipt or proof</small>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" id="recordPaymentBtn">
              <i class="fas fa-check-circle me-2"></i> Record Payment
            </button>
            <button type="button" class="btn btn-secondary" onclick="showPaymentHistory()">
              <i class="fas fa-history me-2"></i> View Payment History
            </button>
          </div>
        </form>

        <!-- Payment History -->
        <div id="payment_history_section" class="mt-4" style="display:none;">
          <hr>
          <h6 class="mb-3"><i class="fas fa-list me-2"></i> Payment History</h6>
          <div id="payment_history_list" class="list-group">
            <!-- Dynamically loaded payment history -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize payment date to today
document.getElementById('payment_date').value = new Date().toISOString().split('T')[0];

// Open payment modal with transaction data
function openPaymentModal(transactionId, description, counterparty, totalAmount, paidAmount, remainingAmount) {
  document.getElementById('transaction_id').value = transactionId;
  document.getElementById('payment_description').textContent = description;
  document.getElementById('payment_counterparty').textContent = counterparty;
  document.getElementById('payment_total').textContent = parseFloat(totalAmount).toFixed(2);
  document.getElementById('payment_paid').textContent = parseFloat(paidAmount).toFixed(2);
  document.getElementById('payment_remaining').textContent = parseFloat(remainingAmount).toFixed(2);
  
  // Update progress bar
  const percentage = totalAmount > 0 ? ((paidAmount / totalAmount) * 100).toFixed(0) : 0;
  const progressBar = document.getElementById('payment_progress_bar');
  const progressText = document.getElementById('payment_progress_text');
  
  progressBar.style.width = percentage + '%';
  progressBar.setAttribute('aria-valuenow', percentage);
  progressText.textContent = percentage + '%';
  
  // Color code progress bar
  if (percentage < 30) {
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-danger';
  } else if (percentage < 70) {
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
  } else if (percentage < 100) {
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
  } else {
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-success';
  }
  
  // Set form action
  document.getElementById('recordPaymentForm').action = `/record-payment/${transactionId}`;
  
  // Reset form
  document.getElementById('recordPaymentForm').reset();
  document.getElementById('payment_date').value = new Date().toISOString().split('T')[0];
  document.getElementById('payment_history_section').style.display = 'none';
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
  modal.show();
}

// Validate payment amount
function validatePaymentAmount() {
  const amountInput = document.getElementById('amount_paid');
  const remaining = parseFloat(document.getElementById('payment_remaining').textContent);
  const amount = parseFloat(amountInput.value) || 0;
  const error = document.getElementById('amount_error');
  const submitBtn = document.getElementById('recordPaymentBtn');
  
  if (amount > remaining) {
    error.style.display = 'block';
    submitBtn.disabled = true;
    amountInput.classList.add('is-invalid');
  } else {
    error.style.display = 'none';
    submitBtn.disabled = false;
    amountInput.classList.remove('is-invalid');
  }
}

// Show payment history
function showPaymentHistory() {
  const transactionId = document.getElementById('transaction_id').value;
  const historySection = document.getElementById('payment_history_section');
  const historyList = document.getElementById('payment_history_list');
  
  // Show loading
  historyList.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"></div></div>';
  historySection.style.display = 'block';
  
  // Fetch payment history via AJAX
  fetch(`/transaction-payments/${transactionId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.payments.length > 0) {
        historyList.innerHTML = data.payments.map(payment => `
          <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">₹${payment.amount_paid}</h6>
              <small class="text-muted">${payment.payment_date}</small>
            </div>
            <p class="mb-1"><strong>${payment.payment_method}</strong></p>
            ${payment.reference_number ? `<small>Ref: ${payment.reference_number}</small>` : ''}
            ${payment.notes ? `<p class="mb-0 text-muted"><small>${payment.notes}</small></p>` : ''}
          </div>
        `).join('');
      } else {
        historyList.innerHTML = '<div class="alert alert-info">No payment history yet.</div>';
      }
    })
    .catch(error => {
      historyList.innerHTML = '<div class="alert alert-danger">Error loading payment history.</div>';
      console.error('Error:', error);
    });
}
</script>

<style>
#paymentModal .progress {
  box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
}

#paymentModal .list-group-item {
  border-left: 4px solid #007bff;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  #paymentModal .modal-dialog {
    margin: 0.5rem;
  }
  
  #paymentModal .card-body {
    padding: 0.75rem;
  }
  
  #paymentModal .progress {
    height: 20px;
  }
  
  #paymentModal .progress-bar span {
    font-size: 0.75rem;
  }
}
</style>
