{% extends 'header.html' %}
{% load static %}

{% block body %}
<style>
    /* Using app's existing theme colors from style.css */
    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .profile-header {
        text-align: center;
        padding: 2rem;
        position: relative;
    }

    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--primary);
        box-shadow: 0 8px 20px rgba(176, 163, 111, 0.3);
        margin-bottom: 1rem;
    }

    .profile-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: var(--primary);
        color: white;
        border-radius: 20px;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(176, 163, 111, 0.1), rgba(154, 130, 23, 0.05));
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        border: 1px solid var(--primary-light);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(176, 163, 111, 0.15);
    }

    .stat-card i {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }

    .stat-card h3 {
        font-size: 1.75rem;
        font-weight: bold;
        color: var(--primary-dark);
        margin: 0.5rem 0 0.25rem 0;
    }

    .stat-card p {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
    }

    .module-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .module-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .module-card:hover {
        background: rgba(176, 163, 111, 0.05);
        border-color: var(--primary);
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(176, 163, 111, 0.2);
    }

    .module-card i {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }

    .module-card h6 {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--primary-dark);
    }

    .module-card .badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background-color: var(--primary);
        border: none;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: var(--primary);
    }

    .action-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: var(--primary-dark-secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(176, 163, 111, 0.3);
        color: white;
    }

    .danger-btn {
        background: #dc3545;
    }

    .danger-btn:hover {
        background: #c82333;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    @media (max-width: 768px) {
        .profile-avatar {
            width: 100px;
            height: 100px;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .module-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
    }
</style>

<div class="container mt-4 mb-5">
    <div class="row g-4">
        <!-- Left Column: Profile Card -->
        <div class="col-lg-4">
            <div class="glass-card profile-header">
                <!-- Profile Picture with Upload Overlay -->
                <div style="position: relative; display: inline-block;">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" class="profile-avatar" alt="Profile Picture" id="profileImage">
                    {% else %}
                        <img src="{% static 'image/user_m.jpg' %}" class="profile-avatar" alt="Profile Picture" id="profileImage">
                    {% endif %}
                    <!--
                    <label for="profilePictureInput" style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        <i class="fa-solid fa-camera"></i>
                    </label>
                    -->
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                </div>
                
                <!-- Editable Name -->
                <div id="nameDisplay" style="margin-top: 1rem;">
                    <h3 style="color: var(--primary-dark); margin-bottom: 0.25rem;">{{user.first_name}} {{user.last_name}}</h3>
                    <button onclick="editName()" class="btn btn-sm" style="background: none; border: none; color: var(--primary); padding: 0.25rem 0.5rem;">
                        <i class="fa-solid fa-pen"></i> Edit
                    </button>
                </div>
                
                <div id="nameEdit" style="display: none; margin-top: 1rem; width: 100%;">
                    <input type="text" id="nameInput" value="{{user.first_name}} {{user.last_name}}" class="form-control mb-2" style="text-align: center;">
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button onclick="saveName()" class="btn btn-sm action-btn">
                            <i class="fa-solid fa-check"></i> Save
                        </button>
                        <button onclick="cancelEdit()" class="btn btn-sm btn-secondary">
                            <i class="fa-solid fa-xmark"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <p style="color: #6b7280; margin: 0.5rem 0;">@{{user.username}}</p>
                <p class="text-muted small mb-2">{{user.email}}</p>
                <span class="profile-badge">
                    <i class="fa-solid fa-circle-check"></i> Verified Member
                </span>
                <p class="text-muted small mt-3" style="font-size: 0.875rem;">
                    <i class="fa-solid fa-calendar-days"></i> Joined {{user.date_joined|date:'M d, Y'}}
                </p>
            </div>
        </div>

        <!-- Right Column: Stats & Content -->
        <div class="col-lg-8">
            <!-- Stats Dashboard -->
            <div class="glass-card">
                <h5 class="section-title">
                    <i class="fa-solid fa-chart-line"></i> Account Overview
                </h5>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fa-solid fa-calendar-days"></i>
                        <h3>{{account_age}}</h3>
                        <p>Days Active</p>
                    </div>
                    <div class="stat-card">
                        <i class="fa-solid fa-receipt"></i>
                        <h3>{{total_transactions}}</h3>
                        <p>Transactions</p>
                    </div>
                    <div class="stat-card">
                        <i class="fa-solid fa-cubes"></i>
                        <h3>{{accessible_modules|length}}</h3>
                        <p>Active Modules</p>
                    </div>
                </div>
            </div>

            <!-- Module Access -->
            <div class="glass-card">
                <h5 class="section-title">
                    <i class="fa-solid fa-grid-2"></i> Module Access
                </h5>
                <div class="module-grid">
                    {% for module in accessible_modules %}
                    <div class="module-card">
                        <i class="fa-solid {{ module.icon }}"></i>
                        <h6>{{ module.title }}</h6>
                        <span class="badge">Active</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Settings -->
            <div class="glass-card">
                <h5 class="section-title">
                    <i class="fa-solid fa-gear"></i> Settings
                </h5>
                
                <!-- Email Preference -->
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 500;">
                        <i class="fa-solid fa-envelope"></i> Email Notifications
                    </label>
                    <select disabled class="form-select">
                        <option>Enabled</option>
                        <option selected>Disabled</option>
                    </select>
                </div>

                <!-- Change Password -->
                <h6 class="mt-4 mb-3" style="font-weight: 600;">
                    <i class="fa-solid fa-lock"></i> Change Password
                </h6>
                {% include 'auth/changePassword.html' %}
            </div>

            {% if user.is_superuser %}
            <div class="glass-card">
                <h5 class="section-title">
                    <i class="fa-solid fa-key"></i> Token Management
                </h5>
                <p class="text-muted small">
                    Last token generated: {{ last_genration | default:"N/A" }}
                </p>
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn action-btn" onclick="getGoogleAuth()">
                            <i class="fa-solid fa-plus"></i> Generate Token
                        </button>
                    </div>
            </div>

            <!-- Database Backup (Admin Only) -->
            <div class="glass-card">
                <h5 class="section-title">
                    <i class="fa-solid fa-database"></i> Database Backup
                </h5>
                <p class="text-muted small">
                    Manually trigger database backup.
                </p>
                <div class="d-flex justify-content-end mt-3 gap-2">
                    <button class="btn action-btn" onclick="triggerBackup()" id="backupButton">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Run Backup
                    </button>
                </div>
                <div id="backupStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-info mb-0">
                        <i class="fa-solid fa-spinner fa-spin"></i> Backup in progress...
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Account Management -->
            <div class="glass-card">
                <h5 class="section-title">
                    <i class="fa-solid fa-user-gear"></i> Account Management
                </h5>
                <p class="text-muted">
                    If you no longer wish to use your account, you can permanently delete it. This action cannot be undone.
                </p>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn action-btn danger-btn" onclick="confirmDeletion()">
                        <i class="fa-solid fa-trash-can"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock body %}

{% block script %}
<script>
    // Profile Picture Upload
    document.getElementById('profilePictureInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Show preview immediately
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('profileImage').src = event.target.result;
            };
            reader.readAsDataURL(file);
            
            // Upload to server
            const formData =  new FormData();
            formData.append('profile_picture', file);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch('/update-profile/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('❌ Failed to update profile picture');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ An error occurred while uploading');
            });
        }
    });
    
    // Name Edit Functions
    function editName() {
        document.getElementById('nameDisplay').style.display = 'none';
        document.getElementById('nameEdit').style.display = 'block';
        document.getElementById('nameInput').focus();
    }
    
    function cancelEdit() {
        document.getElementById('nameDisplay').style.display = 'block';
        document.getElementById('nameEdit').style.display = 'none';
        document.getElementById('nameInput').value = '{{user.first_name}} {{user.last_name}}';
    }
    
    function saveName() {
        const newName = document.getElementById('nameInput').value.trim();
        if (!newName) {
            alert('Name cannot be empty');
            return;
        }
        
        const formData = new FormData();
        formData.append('name', newName);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('/update-profile/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update display
                document.querySelector('#nameDisplay h3').textContent = newName;
                cancelEdit();
            } else {
                alert('❌ Failed to update name');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ An error occurred');
        });
    }

    function getGoogleAuth() {
        fetch('/generate-refresh-token/')
            .then(response => response.json())
            .then(data => {
                if (data.auth_url) {
                    window.location.href = data.auth_url;
                }
            })
            .catch(err => {
                console.error('Error:', err);
            });
    }

    function triggerBackup() {
        const button = document.getElementById('backupButton');
        const statusDiv = document.getElementById('backupStatus');
        
        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Running...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div class="alert alert-info mb-0"><i class="fa-solid fa-spinner fa-spin"></i> Backup in progress... This may take a few moments.</div>';
        
        fetch('/manual-backup/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="fa-solid fa-check-circle"></i> ' + data.message + '</div>';
            } else {
                statusDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fa-solid fa-exclamation-circle"></i> ' + data.message + '</div>';
            }
            
            // Re-enable button
            button.disabled = false;
            button.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Run Backup';
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fa-solid fa-exclamation-circle"></i> An error occurred while running backup.</div>';
            
            button.disabled = false;
            button.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Run Backup';
        });
    }

    function confirmDeletion() {
        if (confirm('⚠️ WARNING: This will permanently delete your account and all associated data. This action cannot be undone.\n\nAre you absolutely sure you want to proceed?')) {
            // Add actual deletion logic here
            alert('We have received your request. We will process it as soon as possible.');
        }
    }
</script>
{% endblock script %}