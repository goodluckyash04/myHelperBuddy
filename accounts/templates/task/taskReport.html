{% extends 'header.html' %}
{% load static %}
{% block body %}

<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center my-3">
    <h2 style="color: var(--primary);font-family: dancing script;">My Tasks - Complete Report</h2>
    <!-- Action Buttons -->
    <div class="d-flex gap-2">
      <a href="/manageCategories/" class="btn btn-outline-primary">
        <i class="fa-solid fa-folder"></i> Categories
      </a>
      <a href="/manageTags/" class="btn btn-outline-success">
        <i class="fa-solid fa-tags"></i> Tags
      </a>
      <a href="/currentMonthTaskReport/" class="btn custom-btn-primary">
        <i class="fa-solid fa-calendar-check"></i> Current Month
      </a>
    </div>
  </div>

  <!-- Advanced Filters Row -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-2">
            <!-- Category Filter -->
            <div class="col-md-3">
              <label class="form-label small fw-bold">Category</label>
              <select class="form-select form-select-sm" id="categoryFilter">
                <option value="">All Categories</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}" style="border-left: 4px solid {{ cat.color }}; padding-left: 8px;">
                    {{ cat.icon|default:"üìÅ" }} {{ cat.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Priority Filter -->
            <div class="col-md-2">
              <label class="form-label small fw-bold">Priority</label>
              <select class="form-select form-select-sm" id="priorityFilter">
                <option value="">All Priorities</option>
                <option value="High">üî¥ High</option>
                <option value="Medium">üü° Medium</option>
                <option value="Low">üü¢ Low</option>
              </select>
            </div>

            <!-- Status Filter -->
            <div class="col-md-2">
              <label class="form-label small fw-bold">Status</label>
              <select class="form-select form-select-sm" id="statusFilter">
                <option value="">All Status</option>
                <option value="Pending">‚è≥ Pending</option>
                <option value="In Progress">üîÑ In Progress</option>
                <option value="Completed">‚úÖ Completed</option>
                <option value="Cancelled">‚ùå Cancelled</option>
              </select>
            </div>

            <!-- Tag Filter -->
            <div class="col-md-3">
              <label class="form-label small fw-bold">Tags</label>
              <select class="form-select form-select-sm" id="tagFilter">
                <option value="">All Tags</option>
                {% for tag in tags %}
                  <option value="{{ tag.id }}">üè∑Ô∏è {{ tag.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Clear Button -->
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearFilters()">
                <i class="fa-solid fa-filter-circle-xmark"></i> Clear Filters
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Table -->
  <div class="row mx-0">
    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
      <table id="myTable" class="table table-striped table-bordered table-hover">
        <thead class="sticky-top bg-light">
          <tr>
            <th style="width: 40px;">#</th>
            <th style="width: 70px;">Score</th>
            <th style="width: 90px;">Priority</th>
            <th style="width: 100px;">Status</th>
            <th style="width: 150px;">Category</th>
            <th>Task Title</th>
            <th style="width: 150px;">Tags</th>
            <th style="width: 110px;">Due Date</th>
            <th style="width: 100px;">Time</th>
            <th style="width: 110px;">Completed</th>
            <th style="width: 140px;" class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="taskTableBody">
          {% if taskData %}
            {% for task in taskData %}
              <tr data-category="{{ task.category.id|default:'' }}" 
                  data-priority="{{ task.priority }}"
                  data-status="{{ task.status }}"
                  data-tags="{% for tag in task.tags.all %}{{ tag.id }},{% endfor %}">
                
                <td>{{ forloop.counter }}</td>
                
                <!-- Priority Score -->
                <td>
                  <span class="badge {% if task.priority_score >= 50 %}bg-danger{% elif task.priority_score >= 30 %}bg-warning{% else %}bg-success{% endif %} rounded-pill">
                    {{ task.priority_score }}
                  </span>
                </td>

                <!-- Priority -->
                <td>
                  {% if task.priority == 'High' %}
                    <span class="badge bg-danger">üî¥ High</span>
                  {% elif task.priority == 'Medium' %}
                    <span class="badge bg-warning text-dark">üü° Med</span>
                  {% else %}
                    <span class="badge bg-success">üü¢ Low</span>
                  {% endif %}
                </td>

                <!-- Status -->
                {% with task.complete_by_date|date:"Y-m-d" as completed_date %}
                {% with "now"|date:"Y-m-d" as today %}
                <td>
                  {% if task.is_deleted %}
                    <span class="badge bg-danger rounded-pill">üóëÔ∏è Deleted</span>
                  {% elif task.status == 'Pending' %}
                    {% if completed_date < today %}
                      <span class="badge bg-danger rounded-pill">‚ö†Ô∏è Overdue</span>
                    {% else %}
                      <span class="badge bg-warning rounded-pill">‚è≥ Pending</span>
                    {% endif %}
                  {% elif task.status == 'In Progress' %}
                    <span class="badge bg-info rounded-pill">üîÑ Progress</span>
                  {% elif task.status == 'Completed' %}
                    <span class="badge bg-success rounded-pill">‚úÖ Done</span>
                  {% else %}
                    <span class="badge bg-secondary rounded-pill">‚ùå Cancelled</span>
                  {% endif %}
                </td>
                {% endwith %}
                {% endwith %}

                <!-- Category -->
                <td>
                  {% if task.category %}
                    <span class="badge" style="background-color: {{ task.category.color }}20; border-left: 3px solid {{ task.category.color }}; color: #333;">
                      {{ task.category.icon|default:"üìÅ" }} {{ task.category.name }}
                    </span>
                  {% else %}
                    <span class="text-muted small">‚Äî</span>
                  {% endif %}
                </td>

                <!-- Task Title with Edit Link -->
                <td>
                  <a href="" data-bs-toggle="modal" class="text-decoration-none fw-bold" 
                     style="color: var(--primary-dark-four);" 
                     data-bs-target="#taskmodal" 
                     onclick="openModalAndGetTask({{ task.id }})">
                    {{ task.name }}
                  </a>
                  {% if task.description %}
                    <br><small class="text-muted">{{ task.description|truncatewords:8 }}</small>
                  {% endif %}
                </td>

                <!-- Tags -->
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    {% for tag in task.tags.all %}
                      <span class="badge rounded-pill" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }};">
                        {{ tag.name }}
                      </span>
                    {% empty %}
                      <span class="text-muted small">‚Äî</span>
                    {% endfor %}
                  </div>
                </td>

                <!-- Due Date -->
                <td>
                  {% if task.complete_by_date %}
                    {{ task.complete_by_date|date:"M d, Y" }}
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>

                <!-- Time Tracking -->
                <td>
                  {% if task.estimated_hours or task.actual_hours %}
                    <small>
                      <i class="fa-solid fa-clock text-info"></i>
                      {% if task.estimated_hours %}
                        <span title="Estimated">{{ task.estimated_hours }}h</span>
                      {% endif %}
                      {% if task.actual_hours %}
                        / <span class="text-success" title="Actual">{{ task.actual_hours }}h</span>
                      {% endif %}
                    </small>
                  {% else %}
                    <span class="text-muted small">‚Äî</span>
                  {% endif %}
                </td>

                <!-- Completed On -->
                <td>
                  {% if task.completed_on %}
                    <small>{{ task.completed_on|date:"M d, Y" }}</small>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>

                <!-- Action Buttons -->
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="{% url 'taskAction' task.id 'complete' %}" 
                       class="btn btn-outline-success" title="Mark Complete">
                      <i class="fa-solid fa-check"></i>
                    </a>
                    <a href="{% url 'taskAction' task.id 'incomplete' %}" 
                       class="btn btn-outline-secondary" title="Mark Incomplete">
                      <i class="fa-solid fa-rotate-left"></i>
                    </a>
                    <a href="" data-bs-toggle="modal" data-bs-target="#taskmodal" 
                       onclick="openModalAndGetTask({{ task.id }})"
                       class="btn btn-outline-primary" title="Edit">
                      <i class="fa-solid fa-edit"></i>
                    </a>
                    <a href="{% url 'taskAction' task.id 'permdeletetask' %}" 
                       class="btn btn-outline-danger" title="Permanent Delete"
                       onclick="return confirm('Permanently delete this task? This cannot be undone!')">
                      <i class="fa-solid fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="11" class="text-center py-5">
                <i class="fa-solid fa-clipboard-list fa-3x text-muted mb-3"></i>
                <p class="text-muted">No tasks found. Start by creating your first task!</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% include 'task/taskModal.html' %}
{% include 'floating_button_individual.html' with m_type='task' %}

{% endblock body %}

{% block script %}
<script src="{% static 'js/task.js' %}"></script>

<script>
// Filter functionality
function clearFilters() {
  document.getElementById('categoryFilter').value = '';
  document.getElementById('priorityFilter').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('tagFilter').value = '';
  filterTasks();
}

function filterTasks() {
  const categoryFilter = document.getElementById('categoryFilter').value;
  const priorityFilter = document.getElementById('priorityFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  const tagFilter = document.getElementById('tagFilter').value;
  
  const rows = document.querySelectorAll('#taskTableBody tr');
  
  rows.forEach(row => {
    const rowCategory = row.dataset.category || '';
    const rowPriority = row.dataset.priority || '';
    const rowStatus = row.dataset.status || '';
    const rowTags = row.dataset.tags || '';
    
    let showRow = true;
    
    // Category filter
    if (categoryFilter && rowCategory !== categoryFilter) {
      showRow = false;
    }
    
    // Priority filter
    if (priorityFilter && rowPriority !== priorityFilter) {
      showRow = false;
    }
    
    // Status filter
    if (statusFilter && rowStatus !== statusFilter) {
      showRow = false;
    }
    
    // Tag filter
    if (tagFilter && !rowTags.includes(tagFilter)) {
      showRow = false;
    }
    
    row.style.display = showRow ? '' : 'none';
  });
}

// Attach filter event listeners
document.getElementById('categoryFilter').addEventListener('change', filterTasks);
document.getElementById('priorityFilter').addEventListener('change', filterTasks);
document.getElementById('statusFilter').addEventListener('change', filterTasks);
document.getElementById('tagFilter').addEventListener('change', filterTasks);

// Reset modal when opening for new task
document.querySelector('[data-bs-target="#taskmodal"]').addEventListener('click', function(e) {
  if (e.target.closest('.floating-button')) {
    resetTaskModal();
  }
});
</script>
{% endblock script %}
