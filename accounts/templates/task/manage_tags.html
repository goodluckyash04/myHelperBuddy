{% extends 'header.html' %}
{% load static %}
{% block body %}

<div class="container-fluid px-4 py-3">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 style="color: var(--primary);font-family: dancing script;">
      <i class="fa-solid fa-tags"></i> Manage Tags
    </h2>
    <div>
      <button class="btn custom-btn-primary" data-bs-toggle="modal" data-bs-target="#tagModal" onclick="resetTagModal()">
        <i class="fa-solid fa-plus"></i> New Tag
      </button>
      <a href="/taskReports/" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left"></i> Back to Tasks
      </a>
    </div>
  </div>

  <!-- Tags Grid -->
  <div class="row g-3">
    {% for tag in tags %}
    <div class="col-md-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h5 class="card-title">
                <span class="badge rounded-pill" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }};">
                  {{ tag.name }}
                </span>
              </h5>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" 
                      data-bs-toggle="modal" 
                      data-bs-target="#tagModal" 
                      onclick="editTag({{ tag.id }}, '{{ tag.name }}', '{{ tag.color }}')">
                <i class="fa-solid fa-edit"></i>
              </button>
              <a href="{% url 'deleteTag' tag.id %}" 
                 class="btn btn-outline-danger"
                 onclick="return confirm('Delete tag \'{{ tag.name }}\'?')">
                <i class="fa-solid fa-trash"></i>
              </a>
            </div>
          </div>
          
          <div class="mt-3 pt-3 border-top text-center">
            <small class="text-muted">
              <i class="fa-solid fa-tasks"></i> {{ tag.get_task_count }} task{{ tag.get_task_count|pluralize }}
            </small>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="text-center py-5">
        <i class="fa-solid fa-tags fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">No Tags Yet</h4>
        <p class="text-muted">Create tags to label and organize your tasks!</p>
        <button class="btn custom-btn-primary" data-bs-toggle="modal" data-bs-target="#tagModal" onclick="resetTagModal()">
          <i class="fa-solid fa-plus"></i> Create First Tag
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Tag Modal -->
<div class="modal fade" id="tagModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tagModalLabel">Add Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/addTag/" method="post" id="tagForm">
          {% csrf_token %}
          
          <div class="mb-3">
            <label for="tagName" class="form-label">
              <i class="fa-solid fa-tag"></i> Tag Name <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" id="tagName" name="name" required>
            <small class="text-muted">Examples: urgent, waiting, quick-win, blocked</small>
          </div>

          <div class="mb-3">
            <label for="tagColor" class="form-label">
              <i class="fa-solid fa-palette"></i> Color
            </label>
            <div class="d-flex gap-2 flex-wrap mb-2">
              <button type="button" class="btn btn-sm" style="background-color: #EF4444; width: 40px; height: 40px;" onclick="setTagColor('#EF4444')"></button>
              <button type="button" class="btn btn-sm" style="background-color: #F59E0B; width: 40px; height: 40px;" onclick="setTagColor('#F59E0B')"></button>
              <button type="button" class="btn btn-sm" style="background-color: #10B981; width: 40px; height: 40px;" onclick="setTagColor('#10B981')"></button>
              <button type="button" class="btn btn-sm" style="background-color: #3B82F6; width: 40px; height: 40px;" onclick="setTagColor('#3B82F6')"></button>
              <button type="button" class="btn btn-sm" style="background-color: #8B5CF6; width: 40px; height: 40px;" onclick="setTagColor('#8B5CF6')"></button>
              <button type="button" class="btn btn-sm" style="background-color: #EC4899; width: 40px; height: 40px;" onclick="setTagColor('#EC4899')"></button>
            </div>
            <input type="color" class="form-control form-control-color w-100" id="tagColor" name="color" value="#10B981">
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn custom-btn-primary" id="tagSaveBtn">
              <i class="fa-solid fa-save"></i> Save Tag
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock body %}

{% block script %}
<script>
function resetTagModal() {
  document.getElementById('tagForm').action = '/addTag/';
  document.getElementById('tagModalLabel').textContent = 'Add Tag';
  document.getElementById('tagSaveBtn').innerHTML = '<i class="fa-solid fa-save"></i> Save Tag';
  document.getElementById('tagForm').reset();
  document.getElementById('tagColor').value = '#10B981';
}

function editTag(id, name, color) {
  document.getElementById('tagForm').action = `/editTag/${id}`;
  document.getElementById('tagModalLabel').textContent = 'Edit Tag';
  document.getElementById('tagSaveBtn').innerHTML = '<i class="fa-solid fa-save"></i> Update Tag';
  document.getElementById('tagName').value = name;
  document.getElementById('tagColor').value = color;
}

function setTagColor(color) {
  document.getElementById('tagColor').value = color;
}
</script>
{% endblock script %}
