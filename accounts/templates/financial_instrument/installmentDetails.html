{% extends 'header.html' %}
{% load static %}
{% block body %}

<style>
/* Enhanced Installment Details Styling */
.detail-header {
    background: linear-gradient(135deg, rgba(var(--primary-rgb, 94, 134, 1), 0.05) 0%, transparent 100%);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.stats-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.08);
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.progress-section {
    background: linear-gradient(135deg, #F9FAFB 0%, #FFFFFF 100%);
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid rgba(var(--primary-rgb, 94, 134, 1), 0.1);
}

.installment-table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.installment-table thead {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
}

.installment-table tbody tr {
    transition: background-color 0.2s ease;
}

.installment-table tbody tr:hover {
    background-color: rgba(var(--primary-rgb, 94, 134, 1), 0.05);
}

.status-icon {
    transition: transform 0.2s ease;
}

.status-icon:hover {
    transform: scale(1.2);
}

.action-btn {
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
}
</style>

<!-- Page Header -->
<div class="container-fluid px-4 py-3">
  <div class="detail-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h2 style="color: var(--primary); font-family: 'Dancing Script'; margin: 0;">
          <i class="fa-solid fa-receipt"></i> {{ product_details.name | title }}
        </h2>
        <p class="text-muted mb-0 mt-1">
          <i class="fa-solid fa-tag"></i> {{ product_details.type }}
        </p>
      </div>
      <div class="d-flex gap-2">
        <button type="button" onclick="generateCSV()" class="btn custom-btn-primary">
          <i class="fa-solid fa-file-csv"></i> Export CSV
        </button>
        <button type="button" onclick="window.history.back()" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left"></i> Back
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Cards Row -->
  <div class="row g-3 mb-4">
    <!-- Amount Summary -->
    <div class="col-md-4">
      <div class="card stats-card h-100">
        <div class="card-body p-4">
          <h6 class="text-muted mb-3"><i class="fa-solid fa-coins"></i> Amount Summary</h6>
          <div class="mb-3">
            <small class="text-muted d-block">Total Amount</small>
            <h4 class="mb-0" style="color: var(--primary); font-weight: 700;">â‚¹ {{ product_details.amount|floatformat:0 }}</h4>
          </div>
          <div class="d-flex justify-content-between">
            <div>
              <small class="text-muted d-block">Paid</small>
              <strong class="text-success">â‚¹ {{ product_details.paid_amount|floatformat:0 }}</strong>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">Remaining</small>
              <strong class="text-danger">â‚¹ {{ product_details.remaining_amount|floatformat:0 }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Installment Progress -->
    <div class="col-md-4">
      <div class="card stats-card h-100">
        <div class="card-body p-4">
          <h6 class="text-muted mb-3"><i class="fa-solid fa-calendar-days"></i> Installment Progress</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">Completed</small>
              <strong>{{ product_details.paid_installment }} / {{ product_details.no_of_installments }}</strong>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar" role="progressbar" 
                   style="width: {% widthratio product_details.paid_installment product_details.no_of_installments 100 %}%; background: linear-gradient(90deg, #10B981 0%, #34D399 100%);"
                   aria-valuenow="{% widthratio product_details.paid_installment product_details.no_of_installments 100 %}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between">
            <div>
              <small class="text-muted d-block">Completion</small>
              <strong style="color: #10B981;">{% widthratio product_details.paid_installment product_details.no_of_installments 100 %}%</strong>
            </div>
            <div class="text-end">
              <small class="text-muted d-block">Remaining</small>
              <strong>{{ product_details.no_of_installments|add:"-"|add:product_details.paid_installment }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline Info -->
    <div class="col-md-4">
      <div class="card stats-card h-100">
        <div class="card-body p-4">
          <h6 class="text-muted mb-3"><i class="fa-solid fa-clock"></i> Timeline & Status</h6>
          <div class="mb-3">
            <small class="text-muted d-block">Started On</small>
            <strong style="color: var(--primary);">{{ product_details.started_on|date:"d M Y" }}</strong>
          </div>
          <div class="mb-3">
            <small class="text-muted d-block">Status</small>
            <span class="badge {% if product_details.status == 'Open' %}bg-success{% else %}bg-secondary{% endif %} px-3 py-2">
              {% if product_details.status == 'Open' %}ðŸŸ¢{% else %}âšª{% endif %} {{ product_details.status }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="card installment-table">
    <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;">
      <h5 class="mb-0" style="font-family: 'Dancing Script';">
        <i class="fa-solid fa-list"></i> Transaction History
      </h5>
    </div>
    <div class="card-body p-0">
      <div style="max-height: 500px; overflow-y: auto;">
        <table id="myTable" class="table table-hover mb-0">
          <thead class="sticky-top" style="background: #F8F9FA;">
            <tr>
              <th scope="col" style="font-weight: 600;">#</th>
              <th scope="col" style="font-weight: 600;">Status</th>
              <th scope="col" style="font-weight: 600;">Payment Date</th>
              <th scope="col" style="font-weight: 600;">Amount</th>
              <th scope="col" style="font-weight: 600;">Description</th>
              <th scope="col" style="font-weight: 600;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if all_transaction %}
              {% for i in all_transaction %}
              <tr>
                <td scope="row"><strong>{{ forloop.counter }}</strong></td>
                <td>
                  <a href="/update-transaction-status/{{ i.id }}" class="text-decoration-none">
                    {% if i.status == 'Completed' %}
                      <i class="fa-solid fa-circle-check fs-5 text-success status-icon" title="Completed"></i>
                    {% else %}
                      <i class="fa-solid fa-circle-exclamation fs-5 text-warning status-icon" title="Pending"></i>
                    {% endif %}
                  </a>
                </td>
                <td>
                  <strong>{{ i.date|date:"d M Y" }}</strong>
                </td>
                <td>
                  <a href="#" data-bs-toggle="modal" data-bs-target="#editExpenseModal" 
                     class="text-decoration-none" style="color: var(--primary); font-weight: 600;" 
                     onclick="openModalAndGetExpense({{ i.id }})">
                    â‚¹ {{ i.amount|floatformat:0 }}
                  </a>
                </td>
                <td>
                  <span class="text-muted">{{ i.description }}</span>
                </td>
                <td>
                  <button type="button" 
                          class="btn btn-sm btn-outline-danger action-btn"
                          data-bs-toggle="modal" 
                          data-bs-target="#confirmModal" 
                          data-url="/delete-transaction/{{ i.id }}"
                          title="Delete">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>            
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center py-5">
                  <i class="fa-solid fa-inbox fa-3x text-muted mb-3"></i>
                  <p class="text-muted">No transactions found</p>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% include 'transaction/editTransactionModal.html' %}
{% include 'utility/confirmation_modal.html' with title='Confirm Delete' body='Are you sure you want to delete this transaction?' confirmButton='Delete' %}

{% endblock body %}

{% block script %}
<script src="{% static 'js/transaction.js' %}"></script>
<script src="{% static 'js/utilityFunction.js' %}"></script>
{% endblock script %}