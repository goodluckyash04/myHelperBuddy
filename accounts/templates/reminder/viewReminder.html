{% extends 'header.html' %}
{% load static %}
{% block body %}

<style>
/* Reminder Cards Styling */
.reminder-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-left: 5px solid;
    border-radius: 12px;
}

.reminder-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.reminder-card.priority-critical {
    border-left-color: #EF4444;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, white 100%);
}

.reminder-card.priority-high {
    border-left-color: #F59E0B;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, white 100%);
}

.reminder-card.priority-medium {
    border-left-color: #FBBF24;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, white 100%);
}

.reminder-card.priority-low {
    border-left-color: #3B82F6;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, white 100%);
}

.priority-filter-btn {
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.priority-filter-btn.active {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.type-badge {
    font-size: 0.85rem;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
}

.quick-action-btn {
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
}
</style>

<!-- Page Header -->
<div class="container-fluid px-4 py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 style="color: var(--primary); font-family: 'Dancing Script';">
      <i class="fa-solid fa-bell"></i> {% if key == "today" %}Today's{% else %}All{% endif %} Reminders
    </h2>
    <div class="d-flex gap-2">
      <a href='{% if key == "today" %}/view-reminder/{% else %}/view-today-reminder/{% endif %}' class="btn custom-btn-primary">
        <i class="fa-solid fa-{% if key == 'today' %}list{% else %}calendar-day{% endif %}"></i> 
        {% if key == "today" %}All{% else %}Today's{% endif %} Reminders
      </a>
    </div>
  </div>

  <!-- Priority Filter Bar -->
  <div class="card shadow-sm border-0 mb-4" style="background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <small class="text-muted fw-bold me-2">
            <i class="fa-solid fa-filter"></i> Filter by Priority:
          </small>
          <button class="btn btn-sm btn-outline-secondary priority-filter-btn active" data-priority="all">
            All
          </button>
          <button class="btn btn-sm priority-filter-btn" data-priority="critical" style="border-color: #EF4444; color: #EF4444;">
            üî¥ Critical
          </button>
          <button class="btn btn-sm priority-filter-btn" data-priority="high" style="border-color: #F59E0B; color: #F59E0B;">
            üü† High
          </button>
          <button class="btn btn-sm priority-filter-btn" data-priority="medium" style="border-color: #FBBF24; color: #FBBF24;">
            üü° Medium
          </button>
          <button class="btn btn-sm priority-filter-btn" data-priority="low" style="border-color: #3B82F6; color: #3B82F6;">
            üîµ Low
          </button>
        </div>
        <div>
          <small class="text-muted">
            <i class="fa-solid fa-list"></i>
            <strong id="resultCount">{{ reminders|length }}</strong> reminder{{ reminders|length|pluralize }}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Reminder Cards Grid -->
  <div class="row g-3" id="reminderGrid">
    {% if reminders %}
      {% for reminder in reminders %}
      <div class="col-12 col-md-6 col-lg-4 reminder-item" data-priority="{{ reminder.priority }}">
        <div class="card reminder-card priority-{{ reminder.priority }} h-100">
          <div class="card-body p-3">
            <!-- Header with Priority & Type -->
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-1" style="font-weight: 700;">
                  {{ reminder.get_priority_icon }} {{ reminder.title | title | truncatechars:30 }}
                </h6>
                <div class="d-flex gap-2 mb-2">
                  <span class="type-badge" style="background: rgba(var(--primary-rgb, 94, 134, 1), 0.1); color: var(--primary);">
                    {{ reminder.get_type_icon }} {{ reminder.get_reminder_type_display }}
                  </span>
                  <span class="badge" style="background: {{ reminder.get_priority_color }}; color: white;">
                    {{ reminder.get_priority_display }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Description -->
            {% if reminder.description %}
            <p class="text-muted mb-2" style="font-size: 0.9rem;">
              {{ reminder.description | truncatechars:80 }}
            </p>
            {% endif %}

            <!-- Date & Time Info -->
            <div class="mb-3 p-2 rounded" style="background: rgba(0, 0, 0, 0.03);">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <small class="text-muted d-block">üìÖ Start Date</small>
                  <strong style="font-size: 0.9rem;">{{ reminder.reminder_date|date:"d M Y" }}</strong>
                </div>
                {% if reminder.reminder_time %}
                <div class="text-end">
                  <small class="text-muted d-block">‚è∞ Time</small>
                  <strong style="font-size: 0.9rem;">{{ reminder.reminder_time|time:"H:i" }}</strong>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Pattern Info for Recurring -->
            {% if reminder.reminder_type == 'weekly' and reminder.weekdays %}
            <div class="mb-2">
              <small class="text-muted">On: </small>
              <small class="fw-bold">
                {% for day in reminder.weekdays %}
                  {% if day == 0 %}Mon{% elif day == 1 %}Tue{% elif day == 2 %}Wed{% elif day == 3 %}Thu{% elif day == 4 %}Fri{% elif day == 5 %}Sat{% else %}Sun{% endif %}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </small>
            </div>
            {% endif %}

            {% if reminder.reminder_type == 'custom' and reminder.custom_repeat_days %}
            <div class="mb-2">
              <small class="text-muted">Repeats every </small>
              <span class="badge bg-secondary">{{ reminder.custom_repeat_days }} days</span>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
              <div class="d-flex gap-1">
                <button onclick="editReminder({{ reminder.id }}, '{{ reminder.title|escapejs }}', '{{ reminder.description|escapejs }}', '{{ reminder.reminder_date|date:'Y-m-d' }}', '{% if reminder.reminder_time %}{{ reminder.reminder_time|time:'H:i' }}{% endif %}', '{{ reminder.reminder_type }}', '{{ reminder.priority }}', {{ reminder.weekdays|default:'null' }}, {{ reminder.month_days|default:'null' }}, {{ reminder.custom_repeat_days|default:'null' }})" class="btn btn-sm btn-outline-primary quick-action-btn" title="Edit">
                  <i class="fa-solid fa-edit"></i>
                </button>
                {% if reminder.can_snooze %}
                <button onclick="snoozeReminder({{ reminder.id }}, 1)" class="btn btn-sm btn-outline-warning quick-action-btn" title="Snooze 1h">
                  <i class="fa-solid fa-clock"></i> 1h
                </button>
                <button onclick="snoozeReminder({{ reminder.id }}, 24)" class="btn btn-sm btn-outline-warning quick-action-btn" title="Snooze 1 day">
                  <i class="fa-solid fa-calendar"></i> 1d
                </button>
                <button onclick="dismissReminder({{ reminder.id }})" class="btn btn-sm btn-outline-info quick-action-btn" title="Dismiss">
                  <i class="fa-solid fa-check"></i>
                </button>
                {% endif %}
              </div>
              <div>
                <a href="/cancel-reminder/{{ reminder.id }}" class="btn btn-sm btn-outline-danger quick-action-btn" onclick="return confirm('Delete {{ reminder.title }}?')" title="Delete">
                  <i class="fa-solid fa-trash"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Empty State -->
      <div class="col-12">
        <div class="text-center py-5">
          <i class="fa-solid fa-bell-slash fa-4x text-muted mb-3"></i>
          <h4 class="text-muted">No Reminders Found</h4>
          <p class="text-muted">
            {% if key == "today" %}
              You have no reminders due today!
            {% else %}
              Create your first reminder to get started.
            {% endif %}
          </p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% include 'reminder/createReminderModal.html' %}
{% include 'floating_button_individual.html' with m_type='reminder' %}

<script>
// Priority filtering
document.querySelectorAll('.priority-filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // Update active state
    document.querySelectorAll('.priority-filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    const priority = this.getAttribute('data-priority');
    const items = document.querySelectorAll('.reminder-item');
    let visibleCount = 0;

    items.forEach(item => {
      if (priority === 'all' || item.getAttribute('data-priority') === priority) {
        item.style.display = 'block';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });

    // Update count
    document.getElementById('resultCount').textContent = visibleCount;
  });
});

// Snooze reminder
function snoozeReminder(id, hours) {
  if (confirm(`Snooze reminder for ${hours} hour(s)?`)) {
    window.location.href = `/snooze-reminder/${id}/${hours}/`;
  }
}

// Dismiss reminder
function dismissReminder(id) {
  if (confirm('Mark this reminder as seen?')) {
    window.location.href = `/dismiss-reminder/${id}/`;
  }
}

// Edit reminder - populate modal
function editReminder(id, title, description, date, time, type, priority, weekdays, monthDays, customDays) {
  // Change modal title
  document.getElementById('reminderModalLabel').innerHTML = '<i class="fa-solid fa-edit"></i> Edit Reminder';
  
  // Change form action to update
  document.getElementById('reminderForm').action = `/update-reminder/${id}/`;
  
  // Populate fields
  document.getElementById('title').value = title;
  document.getElementById('description').value = description;
  document.getElementById('reminder_date').value = date;
  document.getElementById('reminder_time').value = time || '';
  
  // Set priority
  document.querySelectorAll('.priority-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-priority') === priority) {
      btn.classList.add('active');
    }
  });
  document.getElementById('priorityInput').value = priority;
  
  // Set type
  document.querySelectorAll('input[name="reminder_type"]').forEach(radio => {
    if (radio.value === type) {
      radio.checked = true;
      radio.dispatchEvent(new Event('change'));
    }
  });
  
  // Set weekdays if weekly
  if (weekdays) {
    weekdays.forEach(day => {
      const checkbox = document.querySelector(`input[name="weekdays"][value="${day}"]`);
      if (checkbox) checkbox.checked = true;
    });
  }
  
  // Set month days if monthly
  if (monthDays) {
    monthDays.forEach(day => {
      const checkbox = document.querySelector(`input[name="month_days"][value="${day}"]`);
      if (checkbox) checkbox.checked = true;
    });
  }
  
  // Set custom repeat days
  if (customDays) {
    document.getElementById('custom_repeat_days').value = customDays;
  }
  
  // Change button text
  document.querySelector('#reminderForm button[type="submit"]').innerHTML = '<i class="fa-solid fa-save"></i> Update Reminder';
  
  // Open modal
  new bootstrap.Modal(document.getElementById('reminderModal')).show();
}

// Reset modal for creating new reminder
function resetReminderModal() {
  document.getElementById('reminderModalLabel').innerHTML = '<i class="fa-solid fa-bell"></i> Create Smart Reminder';
  document.getElementById('reminderForm').action = '/create-reminder/';
  document.getElementById('reminderForm').reset();
  document.getElementById('priorityInput').value = 'medium';
  document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.priority-btn.medium').classList.add('active');
  document.getElementById('reminder_date').valueAsDate = new Date();
  document.querySelector('#reminderForm button[type="submit"]').innerHTML = '<i class="fa-solid fa-plus-circle"></i> Create Reminder';
}

// Reset modal when closed
document.getElementById('reminderModal')?.addEventListener('hidden.bs.modal', function() {
  resetReminderModal();
});
</script>

{% endblock body %}
