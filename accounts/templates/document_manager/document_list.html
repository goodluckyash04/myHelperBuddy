{% extends 'header.html' %}
{% load static %}
{% block body %}

<style>
/* small polish */

@media (max-width: 575.98px){
  /* make search full width on extra small */
  #fileSearchInput { min-width: 0; }
}

.chip-outline {
  padding: 4px 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 0.75rem;
  color: #555;
  transition: 0.2s;
  text-decoration: none;
}

.chip-outline:hover {
  background: #f0f0f0;
  border-color: #999;
  color: #000;
}
</style>

<div class="container-fluid my-3">
  <div class="row align-items-center">
    <div class="col-12 col-md-6 mb-2 mb-md-0">
      <h1 class="h3 mb-0" style="color:var(--primary); font-family: 'Dancing Script', system-ui, sans-serif;">
        My Documents
      </h1>
    </div>

    <div class="col-12 col-md-6">
      <div class="d-flex justify-content-md-end align-items-center gap-5">
        <!-- search form -->
        <form class="d-flex align-items-center w-100 w-md-auto" method="get" role="search" aria-label="Search files">
          <div class="input-group input-group-sm" style="min-width:220px; max-width:420px;">
            <input
              name="q"
              id="fileSearchInput"
              value="{{ q }}"
              class="form-control form-control-sm"
              placeholder="Search filename or keywords"
              aria-label="Search files"
            />
            {% if tag %}
              <input type="hidden" name="tag" value="{{ tag }}">
            {% endif %}
            <button class="btn btn-outline-secondary btn-sm" type="submit" aria-label="Submit search">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </form>

        <!-- active tag badge -->
        {% if tag %}
          <div class="d-none d-md-block ms-2">
            <span class="badge bg-info text-dark" title="Active tag">
              Tag: {{ tag }}
              <a href="?{% if q %}q={{ q }}&{% endif %}" class="ms-2 text-decoration-none" aria-label="Clear tag">×</a>
            </span>
          </div>
        {% endif %}

        <!-- upload button -->
        <div class="ms-2">
          <button
            class="btn btn-sm custom-btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#fileUploadModal"
            type="button"
          >
            <i class="bi bi-cloud-upload-fill"></i>
          </button>
        </div>
      </div>

      <!-- show active tag under search on small screens -->
      {% if tag %}
        <div class="d-block d-md-none mt-2">
          <span class="badge bg-info text-dark">Tag: {{ tag }}
            <a href="?{% if q %}q={{ q }}&{% endif %}" class="ms-2 text-decoration-none" aria-label="Clear tag">×</a>
          </span>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div id="filesGrid" class="row g-3 m-3">
  {% for f in files %}
  <div class="col-md-6 col-lg-4 file-card" data-filename="{{ f.filename|lower }}" data-mimetype="{{ f.content_type|default:''|lower }}" data-uploaded="{{ f.uploaded_at.isoformat }}" data-size="{{ f.size }}">
    <div class="card card-file h-100 shadow-sm">
      <div class="card-body d-flex flex-column">
        <div class="d-flex align-items-start gap-3 mb-2">
          <!-- icon or thumbnail -->
          <div style="width:56px; height:56px; flex:0 0 56px;">
            {% with ct=f.content_type|default:"" %}
              {% if "pdf" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                   <i class="bi bi-file-earmark-pdf text-danger fs-1"></i> 
                </div>

              {% elif "image" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-earmark-image text-info fs-1"></i>
                </div>

              {% elif "word" in ct or ct == "application/msword" or "officedocument.word" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-earmark-word text-primary fs-1"></i>
                </div>

              {% elif "excel" in ct or ct == "application/vnd.ms-excel" or "spreadsheet" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-earmark-spreadsheet text-success fs-1"></i>
                </div>

              {% elif "powerpoint" in ct or "presentation" in ct or "ppt" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-earmark-slides text-warning fs-1"></i>
                </div>

              {% elif "zip" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-zip text-secondary fs-1"></i>
                </div>

              {% elif "rar" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-zip text-dark fs-1"></i>
                </div>

              {% elif "epub" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-book-half text-info fs-1"></i>
                </div>

              {% elif "text" in ct or ct == "text/plain" %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-text text-muted fs-1"></i>
                </div>

              {% elif "json" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-code text-success fs-1"></i>
                </div>

              {% elif "csv" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-spreadsheet text-success fs-1"></i>
                </div>

              {% elif "opendocument" in ct %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-earmark-text text-primary fs-1"></i>
                </div>

              {% else %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:56px;height:56px;">
                  <i class="bi bi-file-earmark fs-1"></i>
                </div>
              {% endif %}
            {% endwith %}
          </div>

          <div class="flex-grow-1">
          <p class="card-title mb-0 fs-6" title="{{ f.filename }}">{{ f.filename }}</p>
          <div class="small text-muted">
            <span>{{ f.size|default:"unknown" }}</span> ·
            <span>{{ f.content_type|default:"unknown" }}</span> 
          </div>

          <div class="mt-2 d-flex flex-wrap gap-2">
            {% for tag_item in f.keyword_list %}
              <a href="?tag={{ tag_item }}{% if q %}&q={{ q }}{% endif %}"
                class="chip-outline"
                title="Filter by tag: {{ tag_item }}">
                <i class="bi bi-hash"></i> {{ tag_item }}
              </a>
            {% endfor %}
          </div>
          
          </div>

          <!-- three-dot actions -->
          <div class="ms-2 dropdown">
            <a class="text-muted" href="#" id="cardMenu{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots-vertical"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="cardMenu{{ forloop.counter }}">
              {% if f.password_protected %}
              <li>
                <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#pwdModal" data-file-id="{{ f.pk }}" data-filename="{{ f.filename }}">
                  <i class="bi bi-lock-fill me-2"></i> Download (protected)
                </button>
              </li>
              {% else %}
              <li>
                <a class="dropdown-item" href="/document/{{ f.pk }}/download/">
                  <i class="bi bi-download me-2"></i> Download
                </a>
              </li>
              {% endif %}
              <li>
                <button
                  class="dropdown-item "
                  data-bs-toggle="modal"
                  data-bs-target="#editDetailsModal"
                  data-file-id="{{ f.pk }}"
                  data-filename="{{ f.filename }}"
                  data-keywords="{{ f.keywords }}"
                  data-protected="{{ f.password_protected|yesno:'1,0' }}"
                >
                <i class="bi bi-pencil me-2"></i> Edit
                </button>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <button
                  class="dropdown-item text-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteModal"
                  data-file-id="{{ f.pk }}"
                  data-filename="{{ f.filename }}"
                  data-protected="{{ f.password_protected|yesno:'1,0' }}"
                >
                  <i class="bi bi-trash-fill me-2"></i> Delete
                </button>
              </li>
            </ul>
          </div>
        </div>

      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-info">You have not uploaded any files yet.</div>
  </div>
  {% endfor %}
</div>

{% include 'document_manager/document_upload_modal.html' %}
{% include 'document_manager/document_update_modal.html' %}
{% include 'document_manager/document_delete_confirmation_modal.html' %}
{% include 'document_manager/download_password_modal.html' %}
{% endblock body %}

{% block script %}

<script src="{% static 'js/downloadManager.js' %}"></script>
{% endblock %}
